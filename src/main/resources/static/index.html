<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ–æ›¸é¤¨ç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">

<div id="app" class="container py-5">

    <div class="text-center mb-5">
        <h1>åœ–æ›¸é¤¨ç®¡ç†ç³»çµ±</h1>
        <p class="text-muted">Spring Boot + Vue 3 é¢è©¦ä½œå“</p>
    </div>

    <div v-if="!isLoggedIn" class="row justify-content-center">
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-body">
                    <h3 class="card-title text-center mb-3">ç™»å…¥</h3>
                    <form @submit.prevent="login">
                        <div class="mb-3">
                            <label class="form-label">å¸³è™Ÿ</label>
                            <input type="text" v-model="loginForm.username" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å¯†ç¢¼</label>
                            <input type="password" v-model="loginForm.password" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">ç™»å…¥</button>
                    </form>
                    <hr>
                    <p class="text-center small">é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ <a href="#" @click="registerMode = !registerMode">è¨»å†Š</a></p>
                </div>
            </div>

            <div v-if="registerMode" class="card shadow mt-3 bg-white">
                <div class="card-body">
                    <h5 class="text-center">å¿«é€Ÿè¨»å†Š</h5>
                    <input type="text" v-model="regForm.name" placeholder="å¸³è™Ÿ" class="form-control mb-2">
                    <input type="password" v-model="regForm.password" placeholder="å¯†ç¢¼" class="form-control mb-2">
                    <input type="email" v-model="regForm.email" placeholder="Email" class="form-control mb-2">
                    <button @click="register" class="btn btn-success w-100">ç¢ºèªè¨»å†Š</button>
                </div>
            </div>
        </div>
    </div>

    <div v-else>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>ğŸ‘‹ Hi, {{ currentUser }}</h4>
            <button @click="logout" class="btn btn-outline-danger">ç™»å‡º</button>
        </div>

        <div class="mb-3">
            <button class="btn btn-primary me-2" @click="fetchBooks">é‡æ–°æ•´ç†æ›¸å–®</button>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addBookModal">æ–°å¢æ›¸ç±</button>
        </div>

        <div class="card shadow">
            <div class="card-body">
                <table class="table table-hover">
                    <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>æ›¸å</th>
                        <th>ä½œè€…</th>
                        <th>ISBN</th>
                        <th>ç‹€æ…‹</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="book in books" :key="book.isbn">
                        <td>{{ book.id }}</td>
                        <td>{{ book.title }}</td>
                        <td>{{ book.author }}</td>
                        <td>{{ book.isbn }}</td>
                        <td>
                            <span v-if="book.borrowed" class="badge bg-danger">å·²å€Ÿå‡º</span>
                            <span v-else class="badge bg-success">åœ¨åº«</span>
                        </td>
                        <td>
                            <button v-if="!book.borrowed"
                                    @click="borrowBook(book.isbn)"
                                    class="btn btn-sm btn-outline-primary">
                                å€Ÿé–±
                            </button>

                            <button v-else
                                    @click="returnBook(book.isbn)"
                                    class="btn btn-sm btn-outline-success">
                                æ­¸é‚„
                            </button>
                        </td>
                    </tr>
                    <tr v-if="books.length === 0">
                        <td colspan="5" class="text-center text-muted">ç›®å‰æ²’æœ‰æ›¸ç±</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addBookModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ–°å¢æ›¸ç±</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input v-model="newBook.title" class="form-control mb-2" placeholder="æ›¸å">
                    <input v-model="newBook.author" class="form-control mb-2" placeholder="ä½œè€…">
                    <input v-model="newBook.isbn" class="form-control mb-2" placeholder="ISBN">
                    <textarea v-model="newBook.description" class="form-control" placeholder="ç°¡ä»‹"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" @click="addBook" data-bs-dismiss="modal">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                isLoggedIn: false,
                currentUser: '',
                authHeader: '',
                registerMode: false,
                loginForm: { username: '', password: '' },
                regForm: { name: '', password: '', email: '' },
                newBook: { title: '', author: '', isbn: '', description: '' },
                books: []
            }
        },
        methods: {
            async login() {
                const token = 'Basic ' + btoa(this.loginForm.username + ':' + this.loginForm.password);

                try {
                    await axios.get('/api/users/register', {
                        headers: { 'Authorization': token }
                    });

                    this.authHeader = token;
                    this.currentUser = this.loginForm.username;
                    this.isLoggedIn = true;
                    this.fetchBooks();
                } catch (error) {
                    alert("ç™»å…¥å¤±æ•—ï¼šå¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
                }
            },

            async register() {
                if (!this.regForm.name?.trim() ||
                    !this.regForm.password?.trim() ||
                    !this.regForm.email?.trim()) {

                    alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼");
                    return;
                }
                try {
                    await axios.post('/api/users/register', this.regForm);
                    alert("è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥");
                    this.registerMode = false;
                    this.regForm = {};
                } catch (error) {
                    alert("è¨»å†Šå¤±æ•—ï¼š" + (error.response?.data?.message || "æœªçŸ¥éŒ¯èª¤"));
                }
            },

            async fetchBooks() {
                try {
                    const response = await axios.get('/api/books', {
                        headers: { 'Authorization': this.authHeader }
                    });
                    this.books = response.data;
                } catch (error) {
                    console.error(error);
                    if(error.response.status === 401) this.logout();
                }
            },

            async addBook() {
                try {
                    await axios.post('/api/books', this.newBook, {
                        headers: { 'Authorization': this.authHeader }
                    });
                    this.newBook = { title: '', author: '', isbn: '', description: '' };
                    this.fetchBooks();
                } catch (error) {
                    alert("æ–°å¢å¤±æ•—ï¼š" + (error.response?.data?.message || "æ¬Šé™ä¸è¶³æˆ–è³‡æ–™éŒ¯èª¤"));
                }
            },

            async borrowBook(bookIsbn) {
                try {
                    await axios.post(`/api/borrow/${bookIsbn}`, {}, {
                        headers: { 'Authorization': this.authHeader }
                    });
                    alert("å€Ÿé–±æˆåŠŸï¼");
                    this.fetchBooks();
                } catch (error) {
                    alert("å€Ÿé–±å¤±æ•—ï¼š" + (error.response?.data?.message || "æœªçŸ¥éŒ¯èª¤"));
                }
            },

            async returnBook(bookIsbn) {
                try {
                    await axios.post(`/api/return/${bookIsbn}`, {}, {
                        headers: { 'Authorization': this.authHeader }
                    });
                    alert("æ­¸é‚„æˆåŠŸï¼");
                    this.fetchBooks();
                } catch (error) {
                    alert("æ­¸é‚„å¤±æ•—ï¼š" + (error.response?.data?.message || "é€™æœ¬æ›¸ä¸æ˜¯ä½ å€Ÿçš„ï¼Œç„¡æ³•æ­¸é‚„"));
                }
            },

            logout() {
                this.isLoggedIn = false;
                this.authHeader = '';
                this.currentUser = '';
                this.books = [];
            }
        }
    }).mount('#app');
</script>

</body>
</html>